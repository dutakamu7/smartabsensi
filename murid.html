<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Murid ‚Äì Absensi</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg,#f3f6fb 0%, #eef2f7 100%); }
    .card { background: white; border-radius: 12px; box-shadow: 0 6px 24px rgba(15,23,42,0.06); }
    .small-muted { font-size: 0.85rem; color: #6b7280; }
    .avatar { width:42px; height:42px; border-radius:999px; background:linear-gradient(135deg,#60a5fa,#7c3aed); display:inline-flex; align-items:center; justify-content:center; color:white; font-weight:700; }
    /* responsive chart height */
    .chart-box { height:220px; }
    @media(min-width:1024px){ .chart-box{ height:300px; } }

    /* minimal file preview */
    .file-thumb { max-width:100%; max-height:80px; object-fit:cover; border-radius:8px; }
    .btn-primary { background: linear-gradient(90deg,#2563eb,#7c3aed); color:white; }
  </style>
</head>
<body class="min-h-screen flex">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-gradient-to-b from-slate-900 to-slate-800 text-white p-6 hidden md:block">
    <div class="mb-6">
      <h1 class="text-2xl font-extrabold">MURID</h1>
      <p class="text-xs text-slate-300 mt-1">Portal Absensi & Materi</p>
    </div>

    <nav class="space-y-2">
      <button onclick="showPage('dashboard')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5">üè† Dashboard</button>
      <button onclick="showPage('absensi')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5">üïò Absensi</button>
      <button onclick="showPage('statistik')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5">üìà Statistik</button>
      <button onclick="showPage('tugas')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5">üìù Tugas</button>
      <button onclick="showPage('materi')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5">üìö Materi</button>
      <button onclick="showPage('pengumuman')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5">üì¢ Pengumuman</button>
      <button onclick="logout()" class="mt-6 w-full bg-red-600 text-white py-2 rounded-lg">Keluar</button>
    </nav>

    <div class="mt-8 text-xs text-slate-400">
      <div id="userSmall" class="flex items-center space-x-3">
        <div class="avatar" id="avatarInitial">U</div>
        <div>
          <div id="userNameSmall" class="text-sm font-semibold">Nama Murid</div>
          <div class="small-muted" id="userRoleSmall">Kelas - NIS</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 p-6 md:p-10 overflow-y-auto">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h2 id="mainGreeting" class="text-3xl font-bold">Halo, Murid!</h2>
        <p class="small-muted">Selamat datang di dashboardmu ‚Äî cek absensi, tugas, materi, dan pengumuman.</p>
      </div>

      <div class="flex items-center space-x-4">
        <div class="text-right">
          <div id="currentDateTime" class="font-medium"></div>
          <div class="small-muted">Waktu lokal</div>
        </div>
        <div id="profileCompact" class="flex items-center space-x-3">
          <div class="avatar" id="avatarTop">M</div>
        </div>
      </div>
    </header>

    <!-- PAGES: dashboard, absensi, statistik, tugas, materi, pengumuman -->
    <section id="page-dashboard" class="page">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="small-muted">Hadir Hari Ini</div>
              <div id="card-hadir" class="text-2xl font-bold">-</div>
            </div>
            <div class="text-3xl">‚úÖ</div>
          </div>
          <p class="small-muted mt-3">Status absensi terkini kamu</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="small-muted">Tidak Hadir</div>
              <div id="card-alpha" class="text-2xl font-bold">-</div>
            </div>
            <div class="text-3xl">üö´</div>
          </div>
          <p class="small-muted mt-3">Jumlah absen tidak hadir</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="small-muted">Kehadiran (%)</div>
              <div id="card-rate" class="text-2xl font-bold">-</div>
            </div>
            <div class="text-3xl">üìä</div>
          </div>
          <p class="small-muted mt-3">Persentase kehadiran selama periode</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card p-5 lg:col-span-2">
          <h3 class="font-bold mb-3">Grafik Kehadiran 7 Hari Terakhir</h3>
          <div class="chart-box">
            <canvas id="chart7days"></canvas>
          </div>
        </div>

        <div class="card p-5">
          <h3 class="font-bold mb-3">Pengumuman Terbaru</h3>
          <ul id="announcementsList" class="space-y-3 small-muted"></ul>
        </div>
      </div>
    </section>

    <!-- Absensi -->
    <section id="page-absensi" class="page hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="card p-5 lg:col-span-2">
          <h3 class="font-bold mb-3">Kirim Absensi Manual</h3>

          <form id="absensiForm" class="space-y-3" onsubmit="submitAbsensi(event)">
            <div>
              <label class="block small-muted">Nama</label>
              <input id="absensiNama" class="w-full border rounded-lg p-2" required readonly>
            </div>
            <div>
              <label class="block small-muted">Tanggal</label>
              <input id="absensiTanggal" class="w-full border rounded-lg p-2" readonly>
            </div>
            <div>
              <label class="block small-muted">Jam</label>
              <input id="absensiJam" class="w-full border rounded-lg p-2" readonly>
            </div>
            <div>
              <label class="block small-muted">Mata Pelajaran (opsional)</label>
              <input id="absensiMapel" class="w-full border rounded-lg p-2" placeholder="Contoh: Matematika">
            </div>
            <div>
              <label class="block small-muted">Status</label>
              <select id="absensiStatus" class="w-full border rounded-lg p-2">
                <option value="Hadir">Hadir</option>
                <option value="Terlambat">Terlambat</option>
                <option value="Izin">Izin</option>
                <option value="Sakit">Sakit</option>
                <option value="Alpha">Alpha</option>
              </select>
            </div>
            <div>
              <label class="block small-muted">Unggah bukti (foto/pdf) ‚Äî opsional</label>
              <input id="absensiBukti" type="file" accept="image/*,.pdf" class="w-full">
              <div id="previewBukti" class="mt-2"></div>
            </div>

            <div class="flex items-center space-x-3">
              <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Kirim Absensi</button>
              <button type="button" onclick="resetAbsensiForm()" class="px-4 py-2 rounded-lg border">Reset</button>
            </div>
            <p id="absensiNote" class="small-muted mt-2"></p>
          </form>
        </div>

        <div class="card p-5">
          <h3 class="font-bold mb-3">Riwayat Singkat</h3>
          <div id="miniHistory" class="space-y-2 small-muted"></div>
        </div>
      </div>
    </section>

    <!-- Statistik -->
    <section id="page-statistik" class="page hidden">
      <div class="card p-5 mb-6">
        <h3 class="font-bold mb-3">Statistik Kehadiran</h3>
        <div id="fullHistory" class="small-muted"></div>
      </div>
    </section>

    <!-- Tugas -->
    <section id="page-tugas" class="page hidden">
      <div class="card p-5">
        <h3 class="font-bold mb-3">Tugas dari Guru</h3>
        <div id="tugasList" class="space-y-3 small-muted"></div>
        <div id="tugasLoadError" class="text-red-500 mt-3"></div>
      </div>
    </section>

    <!-- Materi -->
    <section id="page-materi" class="page hidden">
      <div class="card p-5">
        <h3 class="font-bold mb-3">Materi Pembelajaran</h3>
        <div id="materiList" class="space-y-3 small-muted"></div>
        <div id="materiLoadError" class="text-red-500 mt-3"></div>
      </div>
    </section>

    <!-- Pengumuman -->
    <section id="page-pengumuman" class="page hidden">
      <div class="card p-5">
        <h3 class="font-bold mb-3">Pengumuman</h3>
        <ul id="fullAnnouncements" class="space-y-3 small-muted"></ul>
      </div>
    </section>
  </main>

  <!-- Simple login modal if not logged in -->
  <div id="loginModal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg w-96">
      <h3 class="font-bold mb-3">Masuk sebagai Murid</h3>
      <form id="loginForm" onsubmit="doLogin(event)" class="space-y-3">
        <div>
          <label class="small-muted">Nama lengkap</label>
          <input id="loginName" class="w-full border rounded-lg p-2" required>
        </div>
        <div>
          <label class="small-muted">Keterangan (opsional: kelas / NIS)</label>
          <input id="loginDetail" class="w-full border rounded-lg p-2">
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeLogin()" class="px-3 py-2 rounded-lg border">Batal</button>
          <button class="btn-primary px-3 py-2 rounded-lg">Masuk</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ---------- Utilities & init ---------- */
function $(id){return document.getElementById(id);}

let rekap = JSON.parse(localStorage.getItem('rekap')) || []; // shared with admin
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

// show/hide page
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  $('page-'+name).classList.remove('hidden');
  // update chart or lists if needed
  if(name === 'dashboard') renderDashboard();
  if(name === 'absensi') prepAbsensiForm();
  if(name === 'tugas') loadTugas();
  if(name === 'materi') loadMateri();
  if(name === 'statistik') renderFullHistory();
  if(name === 'pengumuman') renderFullAnnouncements();
}

// clock
function updateDateTime(){
  $('currentDateTime').textContent = new Date().toLocaleString('id-ID');
}
setInterval(updateDateTime,1000);
updateDateTime();

/* ---------- Login handling ---------- */
function openLogin(){
  $('loginModal').classList.remove('hidden');
}
function closeLogin(){
  $('loginModal').classList.add('hidden');
}
function doLogin(e){
  e.preventDefault();
  const name = $('loginName').value.trim();
  const detail = $('loginDetail').value.trim();
  if(!name) return alert('Nama harus diisi');
  currentUser = { name, detail };
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  closeLogin();
  applyUserToUI();
  showPage('dashboard');
}
function logout(){
  if(!confirm('Yakin ingin logout?')) return;
  localStorage.removeItem('currentUser');
  currentUser = null;
  applyUserToUI();
  openLogin();
}

/* ---------- apply user ---------- */
function applyUserToUI(){
  const name = currentUser?.name || 'Murid';
  const detail = currentUser?.detail || '';
  $('mainGreeting').textContent = currentUser ? `Halo, ${name}!` : 'Halo, Murid!';
  $('userNameSmall').textContent = currentUser ? name : 'Belum masuk';
  $('userRoleSmall').textContent = currentUser ? detail : '';
  $('avatarInitial').textContent = (name[0] || 'M').toUpperCase();
  $('avatarTop').textContent = (name[0] || 'M').toUpperCase();

  // fill absensi form name field if present
  if($('absensiNama')) $('absensiNama').value = currentUser ? name : '';
}

/* ---------- Absensi form ---------- */
function prepAbsensiForm(){
  // set date & time
  const now = new Date();
  const tgl = now.toLocaleDateString('id-ID', { year:'numeric', month:'short', day:'numeric' });
  const jam = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
  $('absensiTanggal').value = tgl;
  $('absensiJam').value = jam;
  $('absensiNote').textContent = '';

  // preview file change
  $('absensiBukti').value = '';
  $('previewBukti').innerHTML = '';
  $('absensiStatus').value = 'Hadir';
}

/* convert file to dataURL */
function fileToDataUrl(file){
  return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = ()=>res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

async function submitAbsensi(e){
  e.preventDefault();
  if(!currentUser) return alert('Silakan login dulu.');
  // check if already submitted today by this user
  const today = new Date().toLocaleDateString('id-ID');
  const already = rekap.some(r => r.nama === currentUser.name && new Date(r.waktu).toLocaleDateString('id-ID') === new Date().toLocaleDateString('id-ID'));
  if(already){
    $('absensiNote').textContent = 'Kamu sudah mengirim absensi hari ini ‚úÖ';
    return;
  }

  const mapel = $('absensiMapel').value.trim();
  const status = $('absensiStatus').value;
  const waktu = new Date().toLocaleString('id-ID', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
  const nama = currentUser.name;
  const fileInput = $('absensiBukti');
  let bukti = null;
  if(fileInput.files && fileInput.files[0]){
    try{
      bukti = await fileToDataUrl(fileInput.files[0]);
    }catch(err){
      console.error(err);
    }
  }

  const entry = { nama, role:'siswa', mapel: mapel||'', waktu, status, bukti };
  rekap.push(entry);
  localStorage.setItem('rekap', JSON.stringify(rekap));
  $('absensiNote').textContent = 'Absensi terkirim ‚úÖ';
  prepAbsensiForm();
  renderMiniHistory();
  renderDashboard(); // update cards & chart
}

/* preview file on selection */
$('absensiBukti')?.addEventListener('change', async function(){
  const f = this.files && this.files[0];
  const p = $('previewBukti');
  p.innerHTML = '';
  if(!f) return;
  if(f.type.startsWith('image/')){
    const url = URL.createObjectURL(f);
    const img = document.createElement('img');
    img.src = url;
    img.className = 'file-thumb';
    p.appendChild(img);
  } else {
    const el = document.createElement('div');
    el.className = 'small-muted';
    el.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
    p.appendChild(el);
  }
});

/* reset */
function resetAbsensiForm(){
  $('absensiMapel').value = '';
  $('absensiBukti').value = '';
  $('previewBukti').innerHTML = '';
  $('absensiNote').textContent = '';
  prepAbsensiForm();
}

/* ---------- Mini history & dashboard render ---------- */
function renderMiniHistory(){
  const hist = rekap.filter(r => r.nama === (currentUser?.name||'')).slice(-5).reverse();
  const el = $('miniHistory');
  el.innerHTML = '';
  if(!hist.length) { el.innerHTML = '<div class="small-muted">Belum ada riwayat absensi.</div>'; return; }
  hist.forEach(h=>{
    const d = document.createElement('div');
    d.innerHTML = `<div class="font-semibold">${h.waktu}</div><div class="small-muted">${h.mapel || '-'} ‚Ä¢ ${h.status}</div>`;
    el.appendChild(d);
  });
}

/* ---------- Dashboard render (cards & chart) ---------- */
let chart7 = null;
function renderDashboard(){
  // compute stats for current user
  const my = rekap.filter(r=> r.nama === (currentUser?.name||''));
  const hadirToday = my.filter(r=>{
    try {
      return new Date(r.waktu).toLocaleDateString('id-ID') === new Date().toLocaleDateString('id-ID');
    } catch { return false; }
  }).length;
  $('card-hadir').textContent = hadirToday ? 'Hadir' : 'Belum';
  const notHere = my.filter(r=> r.status === 'Alpha').length;
  $('card-alpha').textContent = notHere;
  const totalDays = Math.max(1,my.length);
  const hadirCount = my.filter(r=> r.status==='Hadir' || r.status==='Terlambat').length;
  const rate = Math.round((hadirCount/totalDays)*100) + '%';
  $('card-rate').textContent = rate;

  // prepare last 7 days counts
  const labels = [];
  const counts = [];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const label = d.toLocaleDateString('id-ID', { weekday:'short', day:'numeric' });
    labels.push(label);
    const cnt = my.filter(r=> {
      try {
        return new Date(r.waktu).toDateString() === d.toDateString();
      } catch { return false; }
    }).length;
    counts.push(cnt);
  }

  // render chart
  const ctx = $('chart7days').getContext('2d');
  if(chart7) chart7.destroy();
  chart7 = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label:'Kehadiran (jumlah)', data: counts, backgroundColor:'#60a5fa' }]
    },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });

  renderMiniHistory();
  renderAnnouncementsShort();
}

/* ---------- Full history ---------- */
function renderFullHistory(){
  const my = rekap.filter(r=> r.nama === (currentUser?.name||'')).reverse();
  const el = $('fullHistory');
  if(!my.length){ el.innerHTML = '<div class="small-muted">Belum ada data absensi.</div>'; return; }
  el.innerHTML = my.map(r=> `<div class="mb-2"><div class="font-semibold">${r.waktu}</div><div class="small-muted">${r.mapel||'-'} ‚Ä¢ ${r.status}</div></div>`).join('');
}

/* ---------- Announcements (shared with admin) ---------- */
function renderAnnouncementsShort(){
  const ann = JSON.parse(localStorage.getItem('pengumuman')) || [];
  const list = $('announcementsList');
  list.innerHTML = '';
  ann.slice(-5).reverse().forEach(a=>{
    const li = document.createElement('li');
    li.innerHTML = `<div class="font-semibold">${a.judul}</div><div class="small-muted text-sm">${new Date(a.tanggal).toLocaleString('id-ID')}</div>`;
    list.appendChild(li);
  });
}
function renderFullAnnouncements(){
  const ann = JSON.parse(localStorage.getItem('pengumuman')) || [];
  const el = $('fullAnnouncements');
  el.innerHTML = '';
  if(!ann.length) { el.innerHTML = '<div class="small-muted">Belum ada pengumuman.</div>'; return; }
  ann.slice().reverse().forEach(a=>{
    const li = document.createElement('li');
    li.innerHTML = `<div class="font-semibold">${a.judul}</div><div class="small-muted">${a.isi}</div><div class="small-muted text-xs mt-1">${new Date(a.tanggal).toLocaleString('id-ID')}</div>`;
    el.appendChild(li);
  });
}

/* ---------- Tugas & Materi fetch from local JSON ---------- */
async function fetchJsonSafe(url){
  try {
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch (err) {
    console.warn('fetchJsonSafe', url, err);
    return null;
  }
}

async function loadTugas(){
  const el = $('tugasList'); el.innerHTML = 'Memuat...';
  const data = await fetchJsonSafe('tugas.json');
  if(!data) {
    el.innerHTML = '<div class="small-muted text-red-500">Gagal memuat tugas. Pastikan file <code>tugas.json</code> tersedia dan dijalankan lewat server lokal.</div>';
    return;
  }
  if(!Array.isArray(data) || !data.length){ el.innerHTML = '<div class="small-muted">Belum ada tugas.</div>'; return; }
  el.innerHTML = data.map(t=>{
    return `<div class="p-3 border rounded"><div class="font-semibold">${t.judul}</div><div class="small-muted">${t.deskripsi || ''}</div><div class="small-muted text-xs mt-1">Batas: ${t.deadline || '-'}</div></div>`;
  }).join('');
}

async function loadMateri(){
  const el = $('materiList'); el.innerHTML = 'Memuat...';
  const data = await fetchJsonSafe('materi.json');
  if(!data) {
    el.innerHTML = '<div class="small-muted text-red-500">Gagal memuat materi. Pastikan file <code>materi.json</code> tersedia dan dijalankan lewat server lokal.</div>';
    return;
  }
  if(!Array.isArray(data) || !data.length){ el.innerHTML = '<div class="small-muted">Belum ada materi.</div>'; return; }
  el.innerHTML = data.map(m=>{
    const link = m.link ? `<a href="${m.link}" target="_blank" class="text-indigo-600">Buka materi</a>` : (m.file ? `<a href="${m.file}" target="_blank" class="text-indigo-600">Unduh file</a>` : '');
    return `<div class="p-3 border rounded"><div class="font-semibold">${m.judul}</div><div class="small-muted">${m.deskripsi || ''}</div><div class="small-muted text-xs mt-1">${link}</div></div>`;
  }).join('');
}

/* ---------- Init on load ---------- */
(function init(){
  if(!currentUser) {
    openLogin();
  } else {
    applyUserToUI();
    showPage('dashboard');
  }

  // initial renders (if user logged in)
  renderAnnouncementsShort();
  // ensure rekap loaded from storage (admin & murid share same key)
  rekap = JSON.parse(localStorage.getItem('rekap')) || [];
  renderDashboard();
})();
</script>
</body>
</html>
